name: sync-methods-scoring

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run without writing to Notion'
        required: false
        default: 'true'
  push:
    paths:
      - 'data/methods_seed.csv'
      - 'data/scoring_seed.csv'
      - 'tools/notion_sync_methods_scoring.py'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }

      - name: Ensure requests
        run: python -m pip install --upgrade pip requests

      - name: Check secrets present
        run: |
          if [ -z "${{ secrets.NOTION_TOKEN }}" ]; then
            echo "NOTION_TOKEN is not set. Skipping."; exit 1
          fi

      - name: Dry-run flag
        run: |
          if [ "${{ github.event.inputs.dry_run }}" = "false" ]; then
            echo "args=" > args.txt
          else
            echo "args=--dry-run" > args.txt
          fi
          cat args.txt

      - name: Seed CSV column-count check
        run: python tools/check_seed_csv_rectangular.py

      - name: Lint Methods JSON
        run: python tools/check_methods_json.py

      - name: Sync to Notion
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          DB_MTH:       ${{ secrets.NOTION_DB_MTH }}
          DB_SFX:       ${{ secrets.NOTION_DB_SFX }}
        run: |
          ARGS=$(cut -d= -f2 args.txt)
          echo "Running with ARGS='${ARGS}'"
          python tools/notion_sync_methods_scoring.py ${ARGS}
